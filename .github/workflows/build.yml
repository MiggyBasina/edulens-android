name: Build Android APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install EVERY dependency
      run: |
        # UPDATE EVERYTHING
        sudo apt-get update -y
        sudo apt-get upgrade -y

        # 1. JAVA
        sudo apt-get install -y openjdk-17-jdk openjdk-11-jdk
        sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java

        # 2. BUILD ESSENTIALS
        sudo apt-get install -y build-essential ccache cmake ninja-build pkg-config

        # 3. PYTHON DEVELOPMENT
        sudo apt-get install -y python3-dev python3-pip python3-venv python3-setuptools

        # 4. KIVY REQUIREMENTS (CRITICAL!)
        sudo apt-get install -y libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev
        sudo apt-get install -y libsdl2-ttf-dev libportmidi-dev libswscale-dev
        sudo apt-get install -y libavformat-dev libavcodec-dev

        # 5. OPENGL/GRAPHICS
        sudo apt-get install -y libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev

        # 6. MULTIMEDIA
        sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

        # 7. IMAGE FORMATS
        sudo apt-get install -y libjpeg-dev libpng-dev libtiff-dev libwebp-dev libfreetype6-dev

        # 8. AUDIO
        sudo apt-get install -y libmpg123-dev libvorbis-dev libogg-dev libflac-dev

        # 9. COMPRESSION
        sudo apt-get install -y zlib1g-dev libbz2-dev liblzma-dev

        # 10. NETWORK/SSL
        sudo apt-get install -y libffi-dev libssl-dev

        # 11. PYTHON RUNTIME SUPPORT
        sudo apt-get install -y libsqlite3-dev libreadline-dev libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev

        # 12. AUTOTOOLS (fix libffi autoreconf macros)
        sudo apt-get install -y autoconf automake libtool

        # 13. UTILITIES
        sudo apt-get install -y git wget curl zip unzip

        echo "âœ… ALL system dependencies installed"

    - name: Install Python packages
      run: |
        python3 -m pip install --upgrade pip==24.0
        pip install setuptools==70.0.0 wheel==0.43.0
        pip install buildozer==1.5.0
        pip install cython==0.29.33
        pip install virtualenv==20.26.3
        echo "âœ… Python packages installed"

    - name: Create SIMPLE buildozer.spec
      run: |
        echo "[app]" > buildozer.spec
        echo "title = EduLens" >> buildozer.spec
        echo "package.name = edulens" >> buildozer.spec
        echo "package.domain = org.edulens" >> buildozer.spec
        echo "source.dir = ." >> buildozer.spec
        echo "source.include_exts = py,png,jpg,kv,ttf" >> buildozer.spec
        echo "version = 0.1.0" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "# PHASE 1: MINIMAL WORKING" >> buildozer.spec
        echo "requirements = python3,kivy==2.2.1" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "orientation = portrait" >> buildozer.spec
        echo "fullscreen = 0" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "# Android - LET Buildozer HANDLE IT" >> buildozer.spec
        echo "android.skip_update = false" >> buildozer.spec
        echo "android.accept_sdk_license = true" >> buildozer.spec
        echo "android.arch = arm64-v8a" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "[buildozer]" >> buildozer.spec
        echo "log_level = 2" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "[android:permissions]" >> buildozer.spec
        echo "INTERNET" >> buildozer.spec

    - name: Create test app (if main.py fails)
      run: |
        # Backup original main.py
        cp main.py main.py.backup 2>/dev/null || true

        # Create super simple test using a quoted heredoc
        cat > test_main.py << 'EOF'
        from kivy.app import App
        from kivy.uix.label import Label

        class TestApp(App):
            def build(self):
                return Label(text='âœ… EduLens Test - Working!')

        if __name__ == '__main__':
            TestApp().run()
        EOF

        # Temporarily use test
        cp test_main.py main.py
        echo "Created test app for Phase 1"

    - name: Build APK (Phase 1 - MINIMAL)
      timeout-minutes: 120
      run: |
        echo "=== PHASE 1: MINIMAL APK ==="
        echo "Building with ONLY: python3 + kivy"

        # Clean
        rm -rf .buildozer bin .gradle 2>/dev/null || true

        # Build
        buildozer -v android debug 2>&1 | tee build.log

        # Check result
        if ls bin/*.apk 1>/dev/null 2>&1; then
          echo "ðŸŽ‰ PHASE 1 SUCCESS! Basic APK works!"
          ls -lh bin/*.apk
          echo "KEEPING this APK as backup"
          cp bin/*.apk bin/phase1-success.apk 2>/dev/null || true
        else
          echo "âŒ Phase 1 failed. Last error:"
          tail -50 build.log | grep -i error || tail -200 build.log
          exit 1
        fi

    - name: Restore original app
      run: |
        # Restore original
        cp main.py.backup main.py 2>/dev/null || true
        echo "Restored original app"

    - name: Phase 2 - Add real requirements
      run: |
        echo "=== PHASE 2: Adding real packages ==="
        echo "Creating new spec with your actual requirements"

        echo "[app]" > buildozer.spec
        echo "title = EduLens" >> buildozer.spec
        echo "package.name = edulens" >> buildozer.spec
        echo "package.domain = org.edulens" >> buildozer.spec
        echo "source.dir = ." >> buildozer.spec
        echo "source.include_exts = py,png,jpg,kv,ttf,json,txt" >> buildozer.spec
        echo "version = 1.0.0" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "# REAL REQUIREMENTS" >> buildozer.spec
        echo "requirements = python3,kivy==2.3.0,kivymd==1.2.0,numpy,Pillow,protobuf,certifi,requests" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "orientation = portrait" >> buildozer.spec
        echo "fullscreen = 0" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "android.skip_update = false" >> buildozer.spec
        echo "android.accept_sdk_license = true" >> buildozer.spec
        echo "android.arch = arm64-v8a" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "[buildozer]" >> buildozer.spec
        echo "log_level = 2" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "[android:permissions]" >> buildozer.spec
        echo "INTERNET" >> buildozer.spec
        echo "ACCESS_NETWORK_STATE" >> buildozer.spec

    - name: Build APK (Phase 2 - REAL APP)
      timeout-minutes: 120
      run: |
        echo "=== PHASE 2: Building real app ==="

        # Clean previous Phase 2 builds but keep Phase 1
        rm -rf .buildozer .gradle 2>/dev/null || true
        mkdir -p bin

        # Build with real requirements
        buildozer -v android debug 2>&1 | tee build-phase2.log

        if ls bin/*.apk 1>/dev/null 2>&1; then
          echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ COMPLETE SUCCESS! REAL APK BUILT!"
          echo "APKs available:"
          ls -lh bin/*.apk
          # Rename real APK
          mv bin/*.apk bin/edul
