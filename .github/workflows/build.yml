name: Build Android APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK + tools
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            cmdline-tools
            platforms;android-31
        # installs sdkmanager, platform-tools, and Android API 31

      - name: Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Cache Buildozer and Gradle
        uses: actions/cache@v4
        with:
          path: |
            .buildozer
            .gradle
          key: ${{ runner.os }}-buildozer-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
            libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libjpeg-dev libpng-dev libtiff-dev libwebp-dev libfreetype6-dev \
            libmpg123-dev libvorbis-dev libogg-dev libflac-dev \
            zlib1g-dev libbz2-dev liblzma-dev libffi-dev libssl-dev \
            libsqlite3-dev libreadline-dev libncursesw5-dev tk-dev \
            libxml2-dev libxmlsec1-dev git wget curl zip unzip
          echo "✅ system dependencies installed"

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip==24.0
          python3 -m pip install buildozer==1.5.0 cython==0.29.33 virtualenv==20.26.3
          echo "✅ Python packages installed"

      - name: Create buildozer.spec
        run: |
          cat > buildozer.spec <<'EOF'
          [app]
          title = EduLens
          package.name = edulens
          package.domain = org.edulens
          source.dir = .
          source.include_exts = py,png,jpg,kv,ttf,json,txt
          version = 1.0.0
          requirements = python3,kivy==2.3.0,kivymd==1.2.0,numpy,Pillow,protobuf,certifi,requests,libffi
          orientation = portrait
          fullscreen = 0

          [buildozer]
          log_level = 2

          [android]
          accept_sdk_license = true
          archs = arm64-v8a,armeabi-v7a
          api = 31
          minapi = 21
          sdk_path = $ANDROID_HOME

          [android.permissions]
          INTERNET = 1
          ACCESS_NETWORK_STATE = 1
          EOF

      - name: Build APK (debug)
        run: |
          buildozer android debug --verbose
        timeout-minutes: 120

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: edulens-apks
          path: bin/*.apk
          retention-days: 7

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: .buildozer/android/platform/build-*.log
          retention-days: 7
